{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container py-4">
  <div class="card shadow mb-4">
    <div class="card-header bg-info text-white">
      <h4 class="mb-0 text-white">تفاصيل البيع <span class="text-white-50">#{{ sale.pk }}</span></h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>العميل:</strong>
            {% if sale.client %}
              {{ sale.client.name }}
              {% if sale.client.phone %}<span class="text-muted small">({{ sale.client.phone }})</span>{% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </p>
          <p><strong>العنوان:</strong>
            {% if sale.client and sale.client.address %}{{ sale.client.address }}{% else %}<span class="text-muted">-</span>{% endif %}
            {% if sale.client and sale.client.area %}- {{ sale.client.area.name }}{% endif %}
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>المندوب:</strong>
            {% if sale.employee %}{{ sale.employee.name }}{% else %}<span class="text-muted">-</span>{% endif %}
          </p>
          <p><strong>تاريخ البيع:</strong> {{ sale.created_at|date:"Y-m-d H:i" }}</p>
          <p><strong>الإجمالي:</strong>
            <span class="badge bg-success fs-6">{{ sale.total|floatformat:2|intcomma }} SDG</span>
          </p>
        </div>
      </div>
      <hr>
      <h5 class="mb-3">العناصر المباعة</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>المنتج</th>
              <th>رقم التشغيلة</th>
              <th>الكمية</th>
              <th>سعر الوحدة</th>
              <th>الإجمالي</th>
              <th>الخصومات</th>
            </tr>
          </thead>
          <tbody>
            {% for item in sale.items.all %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ item.inventory.product.name }}</td>
              <td>
                {% if item.inventory.shipment.batch_number %}
                  {{ item.inventory.shipment.batch_number }}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {{ item.quantity }}
                {% if item.free_units > 0 %}
                  <span class="badge bg-info text-white ms-1">+{{ item.free_units }} مجاني</span>
                {% endif %}
              </td>
              <td>
                {% if item.price_discount > 0 %}
                  <span class="text-decoration-line-through text-danger">{{ item.price|floatformat:2|intcomma }}</span>
                  <span class="text-success fw-bold">{{ item.discounted_unit_price|floatformat:2|intcomma }}</span>
                {% else %}
                  {{ item.price|floatformat:2|intcomma }}
                {% endif %}
              </td>
              <td>{{ item.get_total|floatformat:2|intcomma }}</td>
              <td>
                {% if item.free_goods_discount > 0 or item.price_discount > 0 %}
                  {% if item.free_goods_discount > 0 %}
                    <div>بضاعة مجانية: {{ item.free_goods_discount|floatformat:2 }}%</div>
                  {% endif %}
                  {% if item.price_discount > 0 %}
                    <div>خصم سعر: {{ item.price_discount|floatformat:2 }}%</div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-3">لا توجد عناصر.</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <td colspan="6" class="text-end"><strong>الإجمالي الكلي:</strong></td>
              <td><strong>{{ sale.total|floatformat:2|intcomma }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="mb-3 mt-3">
        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#returnProductModal">
          <i class="bi bi-arrow-counterclockwise"></i> إرجاع منتج
        </button>
      </div>
      {% if returned_products %}
      <div class="mt-3">
        <h6>المنتجات المرجعة</h6>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>المنتج</th>
              <th>الكمية المرجعة</th>
              <th>القيمة المخصومة</th>
              <th>تاريخ الإرجاع</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody>
            {% for r in returned_products %}
            <tr>
              <td>{{ r.sale_item.inventory.product.name }}</td>
              <td>{{ r.quantity }}</td>
              <td>{{ r.value|floatformat:2|intcomma }}</td>
              <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ r.note|default:"-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
      {% if invoice %}
      <div class="card mt-4">
        <div class="card-header bg-light">
          <h6 class="mb-0">الفاتورة</h6>
        </div>
        <div class="card-body">
          <p><strong>الإجمالي:</strong> <span class="text-success">{{ invoice.sale.total|floatformat:2|intcomma }} SDG</span></p>
          <p><strong>تاريخ الاستحقاق:</strong> {{ invoice.due_date|date:"Y-m-d" }}</p>
          <p>
            <strong>المدفوع:</strong>
            <span class="text-success">{{ invoice.paid_amount|floatformat:"2"|intcomma }} SDG</span>
            <span class="mx-2"></span>
            <strong>المتبقي:</strong>
            <span class="{% if invoice.remaining_amount > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
              {{ invoice.remaining_amount|floatformat:"2"|intcomma|intcomma }} SDG
            </span>
          </p>
          <p><strong>الحالة:</strong>
            {% if invoice.status == 'paid' %}
              <span class="badge bg-success">مدفوعة</span>
            {% elif invoice.status == 'partial' %}
              <span class="badge bg-warning text-dark">مدفوعة جزئياً</span>
            {% else %}
              <span class="badge bg-danger">غير مدفوعة</span>
            {% endif %}
          </p>
          {% if invoice.file_path %}
            <p><a href="{{ invoice.file_path }}"  class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> تحميل الفاتورة</a></p>
          {% endif %}
          {% if invoice.payments.exists %}
            <div class="mt-4">
              <h6>سجل الدفعات</h6>
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>التاريخ</th>
                    <th>المبلغ</th>
                    <th>ملاحظة</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in invoice.payments.all %}
                  <tr>
                    <td>{{ p.paid_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ p.amount|floatformat:"2"|intcomma }}</td>
                    <td>{{ p.note|default:"-" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
          {% if invoice.status != 'paid' %}
            <div class="mt-4">
              <h6>إضافة دفعة جديدة</h6>
              <form method="post" action="{% url 'panel:invoice_add_payment' invoice.pk %}">
                {% csrf_token %}
                <div class="row g-2 align-items-end">
                  <div class="col-md-4">
                    <input type="number" name="amount" class="form-control" min="1" max="{{ invoice.remaining_amount }}" step="0.01" required placeholder="المبلغ">
                  </div>
                  <div class="col-md-5">
                    <input type="text" name="note" class="form-control" placeholder="ملاحظة (اختياري)">
                  </div>
                  <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">إضافة دفعة</button>
                  </div>
                </div>
              </form>
              <form method="post" action="{% url 'panel:invoice_mark_paid' invoice.pk %}" class="mt-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">تحديد كمدفوعة</button>
              </form>
            </div>
          {% endif %}
          <div class="mt-4">
            <a href="{% url 'panel:invoice_pdf' invoice.pk %}" class="btn btn-outline-primary" >
              تحميل PDF
            </a>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-warning mt-4">لا توجد فاتورة مرتبطة بهذا البيع.</div>
      {% endif %}
    </div>
  </div>
  <!-- Return Product Modal -->
  <div class="modal fade" id="returnProductModal" tabindex="-1" aria-labelledby="returnProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'panel:sale_return_product' sale.pk %}" id="returnProductForm">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="returnProductModalLabel">إرجاع منتج</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              {{ return_form.sale_item.label_tag }}
              <select name="sale_item" id="id_sale_item" class="form-select" required>
                <option value="">اختر العنصر</option>
                {% for item in sale.items.all %}
                  <option value="{{ item.id }}" data-max="{{ item.quantity }}">
                    {{ item.inventory.product.name }} ({{ item.quantity }})
                    {% if item.inventory.shipment.batch_number %}
                      - تشغيلة: {{ item.inventory.shipment.batch_number }}
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              {{ return_form.quantity.label_tag }}
              <input type="number" name="quantity" id="id_quantity" class="form-control"
                min="1"
                max="1"
                required
              >
            </div>
            <div class="mb-3">
              {{ return_form.note.label_tag }}
              {{ return_form.note }}
            </div>
            {% if return_form.non_field_errors %}
              <div class="alert alert-danger">{{ return_form.non_field_errors }}</div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-warning">تسجيل الإرجاع</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="text-center">
    <a href="{% url 'panel:sale_list' %}" class="btn btn-secondary mt-2"><i class="bi bi-arrow-right"></i> العودة للقائمة</a>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var saleItemSelect = document.getElementById("id_sale_item");
  var qtyInput = document.getElementById("id_quantity");

  function updateMaxQty() {
    var selectedOption = saleItemSelect.options[saleItemSelect.selectedIndex];
    var maxQty = selectedOption ? selectedOption.getAttribute('data-max') : "1";
    qtyInput.value = "";
    qtyInput.setAttribute('max', maxQty || "1");
  }

  if (saleItemSelect && qtyInput) {
    saleItemSelect.addEventListener('change', updateMaxQty);
    // Set initial max on page load
    updateMaxQty();
  }
});
</script>
{% endblock %}