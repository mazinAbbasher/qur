{% extends "base.html" %}
{% block content %}
{% load humanize %}
<div class="container py-4 mx-auto">
  <div class="flex justify-center">
    <div class="w-full max-w-2xl">
      <div class="bg-white shadow rounded-lg">
        <div class="bg-blue-500 rounded-t-lg px-6 py-4">
          <h5 class="mb-0 text-white text-lg font-bold">تفاصيل المدير: {{ manager.name }}</h5>
        </div>
        {% if messages %}
            <ul class="messages">
              {% for message in messages %}
                <li class="alert alert-{{ message.tags }}">{{ message }}</li>
              {% endfor %}
            </ul>
        {% endif %}
        <div class="px-6 py-6">
          <form method="get" class="mb-6 flex flex-wrap items-center gap-2">
            <label class="me-2 font-semibold">الشهر:</label>
            <select name="month" class="rounded border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" onchange="this.form.submit()">
              {% for m in months %}
                <option value="{{ m.value }}" {% if m.value == month %}selected{% endif %}>{{ m.label }}</option>
              {% endfor %}
            </select>
            <label class="me-2 font-semibold">السنة:</label>
            <input type="number" name="year" value="{{ year }}" class="rounded border-gray-300 px-3 py-2 w-28 focus:ring-2 focus:ring-blue-400" min="2000" max="2100" onchange="this.form.submit()">
            <noscript><button type="submit" class="btn btn-primary btn-sm">عرض</button></noscript>
          </form>
          <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 rounded p-4">
              <div class="mb-2"><span class="font-semibold">مبيعات الشهر:</span> {{ total_sales|floatformat:2|intcomma }}</div>
              <div class="mb-2"><span class="font-semibold">نسبة العمولة:</span> {{ commission_percentage|floatformat:2 }}%</div>
              <div class="mb-2"><span class="font-semibold">قيمة العمولة:</span> {{ commission_amount|floatformat:2|intcomma }}</div>
              <div class="mb-2"><span class="font-semibold text-danger">العمولة غير المدفوعة:</span> {{ unpaid_commission|floatformat:2|intcomma }}</div>
            </div>
            <div class="flex flex-col justify-center">
              <div class="mb-2 font-semibold">الموظفون التابعون:</div>
              <ul class="list-disc ms-4">
                {% for emp in employees %}
                  <li>{{ emp.name }}</li>
                {% empty %}
                  <li>لا يوجد موظفون.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          <div class="mb-6">
            <h6 class="font-bold mt-6 mb-2 text-gray-700">دفع عمولة للمدير:</h6>
            <form method="post" action="{% url 'panel:manager_commission_pay' manager.pk %}" class="flex flex-wrap gap-2 items-center">
              {% csrf_token %}
              <input type="number" name="amount" step="0.01" min="1" max="{{ unpaid_commission }}" class="form-control w-32" placeholder="المبلغ" required>
              <input type="text" name="note" class="form-control w-64" placeholder="ملاحظة (اختياري)">
              <button type="submit" class="btn btn-success">تسجيل دفعة عمولة</button>
            </form>
            <div class="mt-2 text-muted text-xs">يمكنك دفع جزء أو كل العمولة غير المدفوعة للمدير.</div>
          </div>
          <div class="mb-6">
            <h6 class="font-bold mt-6 mb-2 text-gray-700">سجل دفعات العمولات للمدير:</h6>
            <table class="min-w-full divide-y divide-gray-200 border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-right font-bold">التاريخ</th>
                  <th class="px-4 py-2 text-right font-bold">المبلغ</th>
                  <th class="px-4 py-2 text-right font-bold">ملاحظة</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for payment in commission_payments %}
                <tr>
                  <td class="px-4 py-2">{{ payment.paid_at|date:"Y-m-d H:i" }}</td>
                  <td class="px-4 py-2">{{ payment.amount|floatformat:2|intcomma }}</td>
                  <td class="px-4 py-2">{{ payment.note }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">لا توجد دفعات عمولة مسجلة.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <h6 class="font-bold mt-6 mb-2 text-gray-700">مبيعات الموظفين لهذا الشهر:</h6>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-right font-bold">اسم الموظف</th>
                  <th class="px-4 py-2 text-right font-bold">عدد المبيعات</th>
                  <th class="px-4 py-2 text-right font-bold">إجمالي المبيعات</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for emp in employees %}
                <tr>
                  <td class="px-4 py-2">{{ emp.name }}</td>
                  <td class="px-4 py-2">{{ emp.sales_count }}</td>
                  <td class="px-4 py-2">{{ emp.sales_total|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">لا توجد مبيعات لهذا الشهر.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="mt-6">
            <a href="{% url 'panel:manager_list' %}" class="inline-block bg-info text-white px-4 py-2 rounded">رجوع</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
