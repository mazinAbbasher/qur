{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container py-4">
  <div class="mb-3">
    <a href="{% url 'panel:supplier_list' %}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-right"></i> العودة للقائمة</a>
    <a href="{% url 'panel:supplier_edit' supplier.pk %}" class="btn btn-warning btn-sm">تعديل</a>
  </div>
  {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="alert alert-{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
  <div class="card shadow mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0 text-white">تفاصيل المورد: {{ supplier.name }}</h5>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>الهاتف:</strong> {{ supplier.phone|default:"-" }}</p>
          <p><strong>العنوان:</strong> {{ supplier.address|default:"-" }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>ملاحظات:</strong> {{ supplier.note|default:"-" }}</p>
          <p>
            <strong>إجمالي الشحنات:</strong>
            <span class="text-primary">{{ supplier.total_shipments_amount|floatformat:2|intcomma }}</span>
          </p>
          <p>
            <strong>إجمالي المدفوع:</strong>
            <span class="text-success">{{ supplier.total_paid|floatformat:2|intcomma }}</span>
          </p>
          <p>
            <strong>الرصيد المتبقي:</strong>
            <span class="{% if supplier.balance > 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
              {{ supplier.balance|floatformat:2|intcomma }}
            </span>
          </p>
        </div>
      </div>
      <hr>
      <h6>الشحنات المرتبطة</h6>
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>المنتج</th>
              <th>الكمية</th>
              <th>تكلفة الوحدة (جنيه)</th>
              <th>تكلفة الشحن</th>
              <th>تاريخ الاستلام</th>
              <th>رقم التشغيلة</th>
              <th>تاريخ الانتهاء</th>
            </tr>
          </thead>
          <tbody>
            {% for s in shipments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ s.product.name }}</td>
              <td>{{ s.quantity }}</td>
              <td>{{ s.cost_sdg|floatformat:2|intcomma }}</td>
              <td>{{ s.shipment_cost|floatformat:2|intcomma }}</td>
              <td>{{ s.received_at|date:"Y-m-d" }}</td>
              <td>{{ s.batch_number }}</td>
              <td>{{ s.expiry_date|date:"Y-m-d" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted">لا توجد شحنات.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <h6>سجل المدفوعات</h6>
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>التاريخ</th>
              <th>المبلغ</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ p.paid_at|date:"Y-m-d H:i" }}</td>
              <td>{{ p.amount|floatformat:2|intcomma }}</td>
              <td>{{ p.note|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">لا توجد مدفوعات.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <h6>إضافة دفعة جديدة</h6>
      <form method="post" action="{% url 'panel:supplier_add_payment' supplier.pk %}" class="row g-2 align-items-end">
        {% csrf_token %}
        <div class="col-md-4">
          <input type="number" name="amount" class="form-control" min="1" max="{{ supplier.remaining_amount }}" step="0.01" required placeholder="المبلغ">
          <small class="text-muted">المتبقي للمورد: {{ supplier.remaining_amount|floatformat:2|intcomma }}</small>
        </div>
        <div class="col-md-5">
          {{ payment_form.note }}
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary">إضافة دفعة</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
