{% extends "base.html" %}
{% block content %}
{% load humanize %}
<!-- Partner withdrawals/deposits management -->
<div class="container py-4">
  <div class="row mb-3">
    <div class="col-md-8">
      <h4 class="mb-0">العمليات المالية للشريك: {{ partner.full_name }}</h4>
    </div>
    <div class="col-md-4 text-end">
      <a href="{% url 'partners_list' %}" class="btn btn-outline-info">رجوع للشركاء</a>
      <a href="{% url 'transaction_add' partner.id %}" class="btn btn-success" title="إضافة عملية مالية جديدة">إضافة عملية</a>
    </div>
  </div>
  <div class="card shadow mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end" id="filter-form">
        <div class="col-md-3">
          <label class="form-label">العملة</label>
          <select name="currency" class="form-select">
            <option value="">الكل</option>
            {% for currency in currencies %}
              <option value="{{ currency.id }}" {% if currency.id|stringformat:"s" == selected_currency %}selected{% endif %}>{{ currency.code }} - {{ currency.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">نوع العملية</label>
          <select name="transaction_type" class="form-select">
            <option value="">الكل</option>
            <option value="deposit" {% if selected_type == "deposit" %}selected{% endif %}>إيداع</option>
            <option value="withdrawal" {% if selected_type == "withdrawal" %}selected{% endif %}>سحب</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">من تاريخ</label>
          <input type="date" name="date_from" class="form-control" value="{{ date_from|default_if_none:'' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">إلى تاريخ</label>
          <input type="date" name="date_to" class="form-control" value="{{ date_to|default_if_none:'' }}">
        </div>
        <div class="col-md-2 d-flex gap-2">
          <a href="{% url 'partner_transactions_pdf' partner.id %}?{% if selected_currency %}currency={{selected_currency}}&{% endif %}{% if selected_type %}transaction_type={{selected_type}}&{% endif %}{% if date_from %}date_from={{date_from}}&{% endif %}{% if date_to %}date_to={{date_to}}&{% endif %}" class="btn btn-outline-secondary">تحميل PDF</a>
        </div>
      </form>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('filter-form');
          form.querySelectorAll('select, input[type="date"]').forEach(function(input) {
            input.addEventListener('change', function() {
              form.submit();
            });
          });
        });
      </script>
    </div>
  </div>
  <div class="card shadow">
    <div class="card-body">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>النوع</th>
            <th>المبلغ</th>
            <th>العملة</th>
            <th>التاريخ</th>
            <th>ملاحظة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
          <tr>
            <td>{{ tx.get_transaction_type_display }}</td>
            <td>{{ tx.amount|floatformat:0|intcomma }}</td>
            <td>{{ tx.currency.code }}</td>
            <td>{{ tx.date }}</td>
            <td>{{ tx.note }}</td>
            <td>
              <a href="{% url 'transaction_edit' tx.id %}" class="btn btn-warning btn-sm" title="تعديل العملية">تعديل</a>
              <a href="{% url 'transaction_delete' tx.id %}" class="btn btn-danger btn-sm" title="حذف العملية">حذف</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted">لا توجد عمليات.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
